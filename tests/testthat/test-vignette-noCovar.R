dd <- msm::cav
dd <- dd[!is.na(dd$pdiag), ]

# Remove observations where the patient appears to go back to a previous state
# (assumed to be impossible):
id_wrong <- unique(dd$PTNUM[which(dd$state != dd$statemax)])
dd <- dd[-which(dd$PTNUM %in% id_wrong), ]

dd <- dd[, -c(2, 5, 7, 9, 10)]
# rename relevant columns (necessary in current version):
colnames(dd)[1:2] <- c("patient", "time")
ddo <- dd

# Change state names from 1,2,3,4 to well, mild, severe, death
tab <- data.frame(state = 1:4, name = c("well", "mild", "severe", "death"))
dd$state <- tab$name[match(dd$state, tab$state)]

test_that("dd has the correct data", {
  expect_equal(dim(dd), c(2398, 5))
  expect_named(dd, c("patient", "time", "dage", "pdiag", "state"))
})

## ----fig.height=3,fig.align = "center"----------------------------------------
# Specify the graph:
gg <- igraph::graph_from_literal(
  "well" - -+"mild" - -+"severe" - -+"death", "well" - -+"death",
  "mild" - -+"death"
)

## -----------------------------------------------------------------------------
assign("f_01", function(param, x, tt) dexp(tt, exp(param[1])), envir = .GlobalEnv)
assign("f_12", function(param, x, tt) dexp(tt, exp(param[2])), envir = .GlobalEnv)
assign("f_23", function(param, x, tt) dexp(tt, exp(param[3])), envir = .GlobalEnv)
assign("f_03", function(param, x, tt) dexp(tt, exp(param[4])), envir = .GlobalEnv)
assign("f_13", function(param, x, tt) dexp(tt, exp(param[5])), envir = .GlobalEnv)

assign("S_01", function(param, x, tt) 1 - pexp(tt, exp(param[1])), envir = .GlobalEnv)
assign("S_12", function(param, x, tt) 1 - pexp(tt, exp(param[2])), envir = .GlobalEnv)
assign("S_23", function(param, x, tt) 1 - pexp(tt, exp(param[3])), envir = .GlobalEnv)
assign("S_03", function(param, x, tt) 1 - pexp(tt, exp(param[4])), envir = .GlobalEnv)
assign("S_13", function(param, x, tt) 1 - pexp(tt, exp(param[5])), envir = .GlobalEnv)

## -----------------------------------------------------------------------------
test_that("names_of_survival_density works as expected", {
  gg_reference <- data.frame(
    edge_name = c('01', '03', '12', '13', '23'),
    survival_name = c('S_01', 'S_03', 'S_12', 'S_13', 'S_23'),
    density_name = c('f_01', 'f_03', 'f_12', 'f_13', 'f_23'),
    from_prev = c('well', 'well', 'mild', 'mild', 'severe'),
    to_prev = c('mild', 'death', 'severe', 'death', 'death'),
    type = c('trans', 'abs', 'trans', 'abs', 'abs')
  )
  expect_identical(names_of_survival_density(gg), gg_reference)
})

## ----eval=F-------------------------------------------------------------------
startval <- c(-2.5,-1.1,-1.2,-3.1,-2.8)
mlo <- smms(startval, dd, gg, mc_cores = 1L, hessian_matrix = TRUE)
test_that("mlo has the correct data", {
  expect_named(mlo, c("opt", "hess"))
  expect_named(
    mlo$opt,
    c("par", "objective", "convergence", "iterations", "evaluations", "message")
  )
  expect_equal(dim(mlo$hess), c(5, 5))
  expect_equal(mlo$opt$convergence, 0)
  expect_equal(mlo$opt$iterations, 29)
  expect_equal(mlo$opt$evaluations, c("function" = 38, "gradient" = 254))
  expect_equal(mlo$opt$par, c(-2.5, -1.1, -1.2, -3.1, -2.7), tolerance = 1e-1)
})

## -----------------------------------------------------------------------------
# Compute AIC (higher values are better with this definition)
aic <- (-2 * mlo$opt$objective) - 2 * length(mlo$opt$par)
test_that("aic has the correct value", {
  expect_equal(aic, -2887.1, tolerance = 1e-1)
})

# Look at estimates and 95% confidence intervals.
test_that("est_ci has the correct data", {
  data1 <- data.frame(
    estimate = c(-2.51, -1.11, -1.24, -3.11, -2.76),
    lower.ci = c(-2.66, -1.36, -1.48, -3.33, -3.67),
    upper.ci = c(-2.36, -0.86, -1.00, -2.90, -1.84)
  )
  data2 <- data.frame(
    estimate = c(0.08, 0.33, 0.29, 0.04, 0.06),
    lower.ci = c(0.07, 0.26, 0.23, 0.04, 0.03),
    upper.ci = c(0.09, 0.42, 0.37, 0.06, 0.16)
  )
  # On the -Inf to Inf scale:
  expect_equal(round(est_ci(mlo$opt$par, mlo$hess), 2), data1)
  # On the 0 to Inf scale (on the transition intensity scale):
  expect_equal(round(exp(est_ci(mlo$opt$par, mlo$hess)), 2), data2)
})

## -----------------------------------------------------------------------------
tval <- seq(0.01, 30, length = 50)

test_that("occupancy_prob_ci_band has the correct data", {
  p0_ci <- occupancy_prob_ci_band("well", tval, mlo$opt$par, gg, hessian = mlo$hess)
  p1_ci <- occupancy_prob_ci_band("mild", tval, mlo$opt$par, gg, hessian = mlo$hess)
  p2_ci <- occupancy_prob_ci_band("severe", tval, mlo$opt$par, gg, hessian = mlo$hess)
  p3_ci <- occupancy_prob_ci_band("death", tval, mlo$opt$par, gg, hessian = mlo$hess)
  ref_0 <- list(
    est = c(0.99874401, 0.92480072, 0.85633192, 0.79293229, 0.73422654, 0.67986714, 0.62953231, 0.58292408, 0.53976655, 0.49980425, 0.46280060, 0.42853657, 0.39680932, 0.36743103, 0.34022781, 0.31503861, 0.29171432, 0.27011688, 0.25011843, 0.23160059, 0.21445375, 0.19857639, 0.18387453, 0.17026115, 0.15765565, 0.14598341, 0.13517534, 0.12516746, 0.11590053, 0.10731969, 0.09937414, 0.09201685, 0.08520426, 0.07889605, 0.07305488, 0.06764617, 0.06263790, 0.05800043, 0.05370629, 0.04973008, 0.04604825, 0.04263901, 0.03948217, 0.03655906, 0.03385236, 0.03134606, 0.02902531, 0.02687639, 0.02488656, 0.02304405),
    lower = c(0.99860223, 0.91663461, 0.84133043, 0.77215232, 0.70860595, 0.65023660, 0.59662601, 0.54738949, 0.50217323, 0.46065180, 0.42252597, 0.38752051, 0.35538239, 0.32587889, 0.29879607, 0.27393721, 0.25112146, 0.23018254, 0.21096760, 0.19333616, 0.17715906, 0.16231760, 0.14870267, 0.13621402, 0.12475950, 0.11425444, 0.10462104, 0.09578781, 0.08768907, 0.08026449, 0.07345863, 0.06722056, 0.06150353, 0.05626458, 0.05146424, 0.04706630, 0.04303748, 0.03934723, 0.03596749, 0.03287253, 0.03003870, 0.02744429, 0.02506939, 0.02289571, 0.02090648, 0.01908630, 0.01742105, 0.01589775, 0.01450452, 0.01323045),
    upper = c(0.99888578, 0.93296683, 0.87133341, 0.81371226, 0.75984713, 0.70949768, 0.66243860, 0.61845866, 0.57735987, 0.53895669, 0.50307524, 0.46955262, 0.43823624, 0.40898317, 0.38165954, 0.35614000, 0.33230718, 0.31005122, 0.28926926, 0.26986503, 0.25174844, 0.23483519, 0.21904640, 0.20430828, 0.19055179, 0.17771238, 0.16572964, 0.15454711, 0.14411199, 0.13437488, 0.12528965, 0.11681313, 0.10890499, 0.10152753, 0.09464552, 0.08822604, 0.08223833, 0.07665362, 0.07144509, 0.06658762, 0.06205780, 0.05783372, 0.05389496, 0.05022241, 0.04679824, 0.04360582, 0.04062958, 0.03785502, 0.03526860, 0.03285765)
  )
  ref_1 <- list(
    est = c(0.0008096453, 0.0430151826, 0.0730508669, 0.0937534270, 0.1073353132, 0.1155195711, 0.1196457563, 0.1207530960, 0.1196457721, 0.1169441587, 0.1131250251, 0.1085530707, 0.1035056520, 0.0981921627, 0.0927692154, 0.0873525272, 0.0820262179, 0.0768500781, 0.0718652440, 0.0670986236, 0.0625663429, 0.0582764257, 0.0542308715, 0.0504272639, 0.0468600107, 0.0435212970, 0.0404018141, 0.0374913136, 0.0347790255, 0.0322539709, 0.0299051925, 0.0277219230, 0.0256937033, 0.0238104647, 0.0220625821, 0.0204409055, 0.0189367763, 0.0175420299, 0.0162489912, 0.0150504628, 0.0139397088, 0.0129104363, 0.0119567741, 0.0110732513, 0.0102547748, 0.0094966073, 0.0087943453, 0.0081438982, 0.0075414680, 0.0069835295),
    lower = c(0.0006851726, 0.0365690856, 0.0621753957, 0.0796559757, 0.0908242958, 0.0971815581, 0.0999447567, 0.1000803995, 0.0983420371, 0.0953078552, 0.0914152682, 0.0869908758, 0.0822753400, 0.0774434545, 0.0726200147, 0.0678921870, 0.0633190487, 0.0589388836, 0.0547747253, 0.0508385415, 0.0471343767, 0.0436606979, 0.0404121359, 0.0373807683, 0.0345570586, 0.0319305366, 0.0294902862, 0.0272252900, 0.0251246677, 0.0231778375, 0.0213746208, 0.0197053054, 0.0181606804, 0.0167320503, 0.0154112341, 0.0141905558, 0.0130628282, 0.0120213324, 0.0110597954, 0.0101723669, 0.0093535952, 0.0085984039, 0.0079020689, 0.0072601967, 0.0066687033, 0.0061237940, 0.0056219448, 0.0051598846, 0.0047345780, 0.0043432100),
    upper = c(0.000934118, 0.049461280, 0.083926338, 0.107850878, 0.123846331, 0.133857584, 0.139346756, 0.141425792, 0.140949507, 0.138580462, 0.134834782, 0.130115266, 0.124735964, 0.118940871, 0.112918416, 0.106812867, 0.100733387, 0.094761273, 0.088955763, 0.083358706, 0.077998309, 0.072892153, 0.068049607, 0.063473759, 0.059162963, 0.055112057, 0.051313342, 0.047757337, 0.044433383, 0.041330104, 0.038435764, 0.035738541, 0.033226726, 0.030888879, 0.028713930, 0.026691255, 0.024810724, 0.023062727, 0.021438187, 0.019928559, 0.018525822, 0.017222469, 0.016011479, 0.014886306, 0.013840846, 0.012869421, 0.011966746, 0.011127912, 0.010348358, 0.009623849)
  )
  ref_2 <- list(
    est = c(1.335642e-06, 4.385250e-03, 1.466250e-02, 2.790647e-02, 4.212807e-02, 5.602162e-02, 6.877398e-02, 7.992198e-02, 8.924662e-02, 9.669502e-02, 1.023235e-01, 1.062563e-01, 1.086565e-01, 1.097053e-01, 1.095881e-01, 1.084852e-01, 1.065658e-01, 1.039851e-01, 1.008821e-01, 9.737969e-02, 9.358464e-02, 8.958863e-02, 8.546935e-02, 8.129184e-02, 7.710983e-02, 7.296707e-02, 6.889866e-02, 6.493214e-02, 6.108869e-02, 5.738399e-02, 5.382918e-02, 5.043157e-02, 4.719532e-02, 4.412202e-02, 4.121118e-02, 3.846064e-02, 3.586696e-02, 3.342569e-02, 3.113165e-02, 2.897910e-02, 2.696198e-02, 2.507397e-02, 2.330867e-02, 2.165966e-02, 2.012060e-02, 1.868524e-02, 1.734753e-02, 1.610159e-02, 1.494178e-02, 1.386269e-02),
    lower = c(9.563616e-07, 3.202645e-03, 1.090000e-02, 2.107397e-02, 3.225158e-02, 4.338949e-02, 5.377925e-02, 6.297065e-02, 7.071014e-02, 7.689127e-02, 8.151492e-02, 8.465707e-02, 8.644311e-02, 8.702729e-02, 8.657693e-02, 8.526064e-02, 8.324005e-02, 8.066442e-02, 7.766766e-02, 7.436695e-02, 7.086271e-02, 6.723934e-02, 6.356650e-02, 5.990061e-02, 5.628645e-02, 5.275880e-02, 4.934389e-02, 4.606079e-02, 4.292269e-02, 3.993790e-02, 3.711086e-02, 3.444287e-02, 3.193282e-02, 2.957772e-02, 2.737317e-02, 2.531376e-02, 2.339334e-02, 2.160534e-02, 1.994289e-02, 1.839904e-02, 1.696685e-02, 1.563948e-02, 1.441028e-02, 1.327284e-02, 1.222099e-02, 1.124887e-02, 1.035090e-02, 9.521841e-03, 8.756726e-03, 8.050907e-03),
    upper = c(1.714922e-06, 5.567854e-03, 1.842500e-02, 3.473896e-02, 5.200456e-02, 6.865375e-02, 8.376870e-02, 9.687332e-02, 1.077831e-01, 1.164988e-01, 1.231320e-01, 1.278555e-01, 1.308699e-01, 1.323834e-01, 1.325993e-01, 1.317097e-01, 1.298916e-01, 1.273057e-01, 1.240965e-01, 1.203924e-01, 1.163066e-01, 1.119379e-01, 1.073722e-01, 1.026831e-01, 9.793320e-02, 9.317535e-02, 8.845343e-02, 8.380350e-02, 7.925469e-02, 7.483008e-02, 7.054751e-02, 6.642027e-02, 6.245782e-02, 5.866632e-02, 5.504918e-02, 5.160751e-02, 4.834057e-02, 4.524603e-02, 4.232040e-02, 3.955916e-02, 3.695711e-02, 3.450846e-02, 3.220705e-02, 3.004649e-02, 2.802021e-02, 2.612162e-02, 2.434416e-02, 2.268134e-02, 2.112683e-02, 1.967447e-02)
  )
  ref_3 <- list(
    est = c(0.0004450122, 0.0277988483, 0.0559547176, 0.0854078155, 0.1163100806, 0.1485916723, 0.1820479610, 0.2164008407, 0.2513410526, 0.2865565773, 0.3217509108, 0.3566540807, 0.3910285352, 0.4246714842, 0.4574148529, 0.4891236930, 0.5196936586, 0.5490479797, 0.5771342300, 0.6039210941, 0.6293952645, 0.6535585502, 0.6764252409, 0.6980197468, 0.7183745160, 0.7375282194, 0.7555241877, 0.7724090791, 0.7882317568, 0.8030423513, 0.8168914883, 0.8298296585, 0.8419067121, 0.8531714584, 0.8636713572, 0.8734522849, 0.8825583660, 0.8910318568, 0.8989130740, 0.9062403580, 0.9130500662, 0.9193765890, 0.9252523845, 0.9307080267, 0.9357722650, 0.9404720911, 0.9448328114, 0.9488781229, 0.9526301912, 0.9561097288),
    lower = c(0.0003498628, 0.0223369744, 0.0457986490, 0.0710234578, 0.0980497713, 0.1267398099, 0.1568495493, 0.1880828318, 0.2201283277, 0.2526824711, 0.2854624689, 0.3182128896, 0.3507083401, 0.3827538405, 0.4141838773, 0.4448607086, 0.4746722618, 0.5035298322, 0.5313657118, 0.5581308374, 0.5837925151, 0.6083322638, 0.6317438003, 0.6540311855, 0.6752071357, 0.6952915036, 0.7143099230, 0.7322926118, 0.7492733245, 0.7652884426, 0.7803761922, 0.7945759775, 0.8079278171, 0.8204718734, 0.8322480635, 0.8432957421, 0.8536534463, 0.8633586954, 0.8724478364, 0.8809559295, 0.8889166669, 0.8963623201, 0.9033237110, 0.9098302012, 0.9159096986, 0.9215886760, 0.9268922000, 0.9318439677, 0.9364663496, 0.9407804372),
    upper = c(0.0005401616, 0.0332607221, 0.0661107863, 0.0997921732, 0.1345703899, 0.1704435348, 0.2072463727, 0.2447188497, 0.2825537774, 0.3204306834, 0.3580393528, 0.3950952718, 0.4313487303, 0.4665891279, 0.5006458286, 0.5333866774, 0.5647150554, 0.5945661271, 0.6229027481, 0.6497113508, 0.6749980140, 0.6987848367, 0.7211066814, 0.7420083081, 0.7615418963, 0.7797649352, 0.7967384523, 0.8125255464, 0.8271901890, 0.8407962600, 0.8534067843, 0.8650833395, 0.8758856070, 0.8858710434, 0.8950946509, 0.9036088277, 0.9114632856, 0.9187050183, 0.9253783117, 0.9315247866, 0.9371834655, 0.9423908579, 0.9471810580, 0.9515858522, 0.9556348314, 0.9593555061, 0.9627734227, 0.9659122781, 0.9687940328, 0.9714390205)
  )
  expect_equal(p0_ci, ref_0, tolerance = 1e-6)
  expect_equal(p1_ci, ref_1, tolerance = 1e-6)
  expect_equal(p2_ci, ref_2, tolerance = 1e-6)
  expect_equal(p3_ci, ref_3, tolerance = 1e-6)
})

## ----fig.width=6,fig.align = "center",fig.height=4----------------------------
# msm package (to get non-parameteric prevalence curves)
oneway4.q <- rbind(
  c(0, 0.25, 0, 0.25), c(0, 0, 0.25, 0.25), c(0, 0, 0, 0.5),
  c(0, 0, 0, 0)
)
rownames(oneway4.q) <- colnames(oneway4.q) <- c(
  "Well", "Mild", "Severe",
  "Death"
)
cav.msm <- msm::msm(state ~ time,
  subject = patient, data = ddo, qmatrix = oneway4.q,
  death = 4, method = "BFGS"
)

prev_np <- msm::prevalence.msm(cav.msm, times = tval)

## ----message=F,error=F, fig.width=6,fig.align = "center",fig.height=4---------
tval <- seq(0.01, 30, length = 50)

test_that("overall_survival_ci_band works", {
  So <- overall_survival_ci_band(tval, mlo$opt$par, gg, hessian = mlo$hess)
  So_ref <- list(
    est = c(0.99955499, 0.97220115, 0.94404528, 0.91459218, 0.88368992, 0.85140833, 0.81795204, 0.78359916, 0.74865895, 0.71344342, 0.67824909, 0.64334592, 0.60897146, 0.57532852, 0.54258515, 0.51087631, 0.48030634, 0.45095202, 0.42286577, 0.39607891, 0.37060474, 0.34644145, 0.32357476, 0.30198025, 0.28162548, 0.26247178, 0.24447581, 0.22759092, 0.21176824, 0.19695765, 0.18310851, 0.17017034, 0.15809329, 0.14682854, 0.13632864, 0.12654772, 0.11744163, 0.10896814, 0.10108693, 0.09375964, 0.08694993, 0.08062341, 0.07474762, 0.06929197, 0.06422773, 0.05952791, 0.05516719, 0.05112188, 0.04736981, 0.04389027),
    lower = c(0.99945984, 0.96673928, 0.93388921, 0.90020783, 0.86542961, 0.82955647, 0.79275363, 0.75528115, 0.71744622, 0.67956932, 0.64196065, 0.60490473, 0.56865127, 0.53341087, 0.49935417, 0.46661332, 0.43528494, 0.40543387, 0.37709725, 0.35028865, 0.32500199, 0.30121516, 0.27889332, 0.25799169, 0.23845810, 0.22023506, 0.20326155, 0.18747445, 0.17280981, 0.15920374, 0.14659322, 0.13491666, 0.12411439, 0.11412896, 0.10490535, 0.09639117, 0.08853671, 0.08129498, 0.07462169, 0.06847521, 0.06281653, 0.05760914, 0.05281894, 0.04841415, 0.04436517, 0.04064449, 0.03722658, 0.03408772, 0.03120597, 0.02856098),
    upper = c(0.99965014, 0.97766303, 0.95420135, 0.92897654, 0.90195023, 0.87326019, 0.84315045, 0.81191717, 0.77987167, 0.74731753, 0.71453753, 0.68178711, 0.64929166, 0.61724616, 0.58581612, 0.55513929, 0.52532774, 0.49647017, 0.46863429, 0.44186916, 0.41620748, 0.39166774, 0.36825620, 0.34596881, 0.32479286, 0.30470850, 0.28569008, 0.26770739, 0.25072668, 0.23471156, 0.21962381, 0.20542402, 0.19207218, 0.17952813, 0.16775194, 0.15670426, 0.14634655, 0.13664130, 0.12755216, 0.11904407, 0.11108333, 0.10363768, 0.09667629, 0.09016980, 0.08409030, 0.07841132, 0.07310780, 0.06815603, 0.06353365, 0.05921956)
  )
  expect_equal(So, So_ref, tolerance = 1e-6)
})

## -----------------------------------------------------------------------------
tval <- seq(10, 40, length = 50)
vt <- 10
test_that("transition_prob_ci_band works as expected", {
  t01_ci <- transition_prob_ci_band("well-mild", tval, vt, mlo$opt$par, gg,
    hessian = mlo$hess
  )
  t12_ci <- transition_prob_ci_band("mild-severe", tval, vt, mlo$opt$par, gg,
    hessian = mlo$hess
  )
  t23_ci <- transition_prob_ci_band("severe-death", tval, vt, mlo$opt$par, gg,
    hessian = mlo$hess
  )
  t13_ci <- transition_prob_ci_band("mild-death", tval, vt, mlo$opt$par, gg,
    hessian = mlo$hess
  )
  t03_ci <- transition_prob_ci_band("well-death", tval, vt, mlo$opt$par, gg,
    hessian = mlo$hess
  )
  ref_01 <- list(
    est = c(0.000000000, 0.042444034, 0.072658658, 0.093494627, 0.107175191, 0.115431702, 0.119610103, 0.120754521, 0.119672894, 0.116988469, 0.113180209, 0.108614483, 0.103569916, 0.098256863, 0.092832659, 0.087413564, 0.082084101, 0.076904358, 0.071915691, 0.067145165, 0.062609017, 0.058315347, 0.054266208, 0.050459214, 0.046888791, 0.043547132, 0.040424929, 0.037511929, 0.034797354, 0.032270214, 0.029919541, 0.027734554, 0.025704782, 0.023820145, 0.022071003, 0.020448196, 0.018943055, 0.017547403, 0.016253557, 0.015054310, 0.013942917, 0.012913079, 0.011958916, 0.011074952, 0.010256088, 0.009497580, 0.008795021, 0.008144316, 0.007541661, 0.006983529),
    lower = c(0.000000000, 0.036081901, 0.061841938, 0.079439744, 0.090695654, 0.097116919, 0.099925743, 0.100092977, 0.098375682, 0.095354810, 0.091469907, 0.087049189, 0.082334529, 0.077501614, 0.072675895, 0.067945010, 0.063368374, 0.058984511, 0.054816616, 0.050876769, 0.047169086, 0.043692078, 0.040440401, 0.037406142, 0.034579767, 0.031950802, 0.029508320, 0.027241294, 0.025138830, 0.023190334, 0.021385613, 0.019714944, 0.018169101, 0.016739379, 0.015417585, 0.014196033, 0.013067526, 0.012025336, 0.011063183, 0.010175209, 0.009355955, 0.008600338, 0.007903629, 0.007261429, 0.006669650, 0.006124491, 0.005622426, 0.005160180, 0.004734714, 0.004343210),
    upper = c(0.000000000, 0.048806166, 0.083475379, 0.107549511, 0.123654727, 0.133746485, 0.139294463, 0.141416066, 0.140970106, 0.138622128, 0.134890510, 0.130179776, 0.124805304, 0.119012112, 0.112989424, 0.106882118, 0.100799827, 0.094824205, 0.089014766, 0.083413560, 0.078048947, 0.072938617, 0.068092015, 0.063512286, 0.059197815, 0.055143463, 0.051341539, 0.047782565, 0.044455878, 0.041350094, 0.038453468, 0.035754165, 0.033240464, 0.030900910, 0.028724421, 0.026700360, 0.024818583, 0.023069470, 0.021443931, 0.019933410, 0.018529880, 0.017225820, 0.016014204, 0.014888475, 0.013842526, 0.012870669, 0.011967616, 0.011128451, 0.010348608, 0.009623849)
  )
  ref_12 <- list(
    est = c(0.0000000000, 0.1639669482, 0.2662552130, 0.3243765671, 0.3513956953, 0.3569953812, 0.3482953200, 0.3304802733, 0.3072808726, 0.2813407029, 0.2544957595, 0.2279865041, 0.2026181752, 0.1788814599, 0.1570428763, 0.1372120707, 0.1193915799, 0.1035133170, 0.0894650495, 0.0771093681, 0.0662970519, 0.0568762793, 0.0486987843, 0.0416237875, 0.0355203241, 0.0302684375, 0.0257595826, 0.0218964957, 0.0185927174, 0.0157719033, 0.0133670192, 0.0113194883, 0.0095783354, 0.0080993606, 0.0068443591, 0.0057803999, 0.0048791679, 0.0041163697, 0.0034712039, 0.0029258902, 0.0024652547, 0.0020763667, 0.0017482212, 0.0014714632, 0.0012381492, 0.0010415405, 0.0008759257, 0.0007364682, 0.0006190754, 0.0005202865),
    lower = c(0.000000e+00, 1.270463e-01, 2.111826e-01, 2.620449e-01, 2.874398e-01, 2.937469e-01, 2.862653e-01, 2.694343e-01, 2.469043e-01, 2.215348e-01, 1.954231e-01, 1.699983e-01, 1.461559e-01, 1.243951e-01, 1.049364e-01, 8.781315e-02, 7.293995e-02, 6.016082e-02, 4.928289e-02, 4.009902e-02, 3.240250e-02, 2.599626e-02, 2.069809e-02, 1.634332e-02, 1.278564e-02, 9.896810e-03, 7.565700e-03, 5.696898e-03, 4.209154e-03, 3.033769e-03, 2.113031e-03, 1.398740e-03, 8.508663e-04, 4.363333e-04, 1.279521e-04, -9.651706e-05, -2.551743e-04, -3.626760e-04, -4.308269e-04, -4.690824e-04, -4.849702e-04, -4.844444e-04, -4.721801e-04, -4.518172e-04, -4.261632e-04, -3.973583e-04, -3.670117e-04, -3.363122e-04, -3.061184e-04, -2.770312e-04),
    upper = c(0.000000000, 0.200887550, 0.321327827, 0.386708245, 0.415351605, 0.420243906, 0.410325335, 0.391526223, 0.367657466, 0.341146560, 0.313568376, 0.285974740, 0.259080493, 0.233367819, 0.209149380, 0.186610996, 0.165843213, 0.146865815, 0.129647206, 0.114119717, 0.100191603, 0.087756303, 0.076699479, 0.066904253, 0.058255009, 0.050640065, 0.043953465, 0.038096093, 0.032976281, 0.028510037, 0.024621008, 0.021240236, 0.018305804, 0.015762388, 0.013560766, 0.011657317, 0.010013510, 0.008595415, 0.007373235, 0.006320863, 0.005415480, 0.004637178, 0.003968622, 0.003394744, 0.002902462, 0.002480439, 0.002118863, 0.001809249, 0.001544269, 0.001317604)
  )
  ref_23 <- list(
    est = c(0.0000000, 0.1620952, 0.2979155, 0.4117200, 0.5070773, 0.5869777, 0.6539266, 0.7100234, 0.7570272, 0.7964119, 0.8294126, 0.8570640, 0.8802332, 0.8996468, 0.9159136, 0.9295436, 0.9409642, 0.9505336, 0.9585519, 0.9652704, 0.9708999, 0.9756169, 0.9795693, 0.9828810, 0.9856559, 0.9879810, 0.9899292, 0.9915617, 0.9929295, 0.9940756, 0.9950359, 0.9958406, 0.9965148, 0.9970797, 0.9975531, 0.9979497, 0.9982821, 0.9985605, 0.9987939, 0.9989894, 0.9991532, 0.9992905, 0.9994055, 0.9995018, 0.9995826, 0.9996502, 0.9997069, 0.9997544, 0.9997942, 0.9998276),
    lower = c(0.0000000, 0.1261458, 0.2376712, 0.3360015, 0.4224841, 0.4983764, 0.5648393, 0.6229356, 0.6736314, 0.7177995, 0.7562239, 0.7896064, 0.8185717, 0.8436748, 0.8654067, 0.8842008, 0.9004384, 0.9144546, 0.9265428, 0.9369598, 0.9459298, 0.9536482, 0.9602850, 0.9659882, 0.9708859, 0.9750895, 0.9786953, 0.9817866, 0.9844356, 0.9867043, 0.9886465, 0.9903084, 0.9917298, 0.9929451, 0.9939837, 0.9948709, 0.9956286, 0.9962754, 0.9968274, 0.9972983, 0.9976999, 0.9980423, 0.9983341, 0.9985828, 0.9987946, 0.9989750, 0.9991286, 0.9992593, 0.9993705, 0.9994652),
    upper = c(0.0000000, 0.1980445, 0.3581598, 0.4874385, 0.5916705, 0.6755790, 0.7430139, 0.7971113, 0.8404230, 0.8750244, 0.9026012, 0.9245216, 0.9418947, 0.9556188, 0.9664205, 0.9748864, 0.9814900, 0.9866127, 0.9905610, 0.9935811, 0.9958700, 0.9975856, 0.9988535, 0.9997738, 1.0004259, 1.0008725, 1.0011632, 1.0013367, 1.0014234, 1.0014468, 1.0014253, 1.0013727, 1.0012997, 1.0012143, 1.0011225, 1.0010285, 1.0009355, 1.0008456, 1.0007603, 1.0006804, 1.0006065, 1.0005386, 1.0004768, 1.0004209, 1.0003706, 1.0003255, 1.0002853, 1.0002496, 1.0002180, 1.0001900)
  )
  ref_13 <- list(
    est = c(0.00000000, 0.03454133, 0.06168838, 0.08302407, 0.09979241, 0.11297116, 0.12332873, 0.13146905, 0.13786677, 0.14289493, 0.14684671, 0.14995253, 0.15239349, 0.15431192, 0.15581966, 0.15700464, 0.15793595, 0.15866790, 0.15924316, 0.15969527, 0.16005060, 0.16032986, 0.16054935, 0.16072184, 0.16085741, 0.16096396, 0.16104770, 0.16111352, 0.16116524, 0.16120589, 0.16123784, 0.16126295, 0.16128269, 0.16129820, 0.16131039, 0.16131997, 0.16132750, 0.16133342, 0.16133807, 0.16134172, 0.16134460, 0.16134685, 0.16134863, 0.16135002, 0.16135112, 0.16135198, 0.16135266, 0.16135319, 0.16135361, 0.16135394),
    lower = c(0.000000000, 0.003218022, 0.006025755, 0.008421054, 0.010430047, 0.012093004, 0.013455400, 0.014562523, 0.015456470, 0.016174691, 0.016749511, 0.017208226, 0.017573503, 0.017863935, 0.018094624, 0.018277746, 0.018423065, 0.018538375, 0.018629882, 0.018702513, 0.018760177, 0.018805972, 0.018842353, 0.018871263, 0.018894244, 0.018912516, 0.018927047, 0.018938605, 0.018947800, 0.018955116, 0.018960937, 0.018965568, 0.018969254, 0.018972187, 0.018974521, 0.018976377, 0.018977855, 0.018979030, 0.018979965, 0.018980709, 0.018981300, 0.018981771, 0.018982145, 0.018982442, 0.018982679, 0.018982867, 0.018983016, 0.018983135, 0.018983229, 0.018983304),
    upper = c(0.00000000, 0.06586463, 0.11735101, 0.15762708, 0.18915478, 0.21384931, 0.23320206, 0.24837558, 0.26027707, 0.26961517, 0.27694391, 0.28269684, 0.28721348, 0.29075990, 0.29354470, 0.29573154, 0.29744884, 0.29879743, 0.29985644, 0.30068803, 0.30134102, 0.30185376, 0.30225634, 0.30257242, 0.30282058, 0.30301541, 0.30316836, 0.30328843, 0.30338268, 0.30345667, 0.30351475, 0.30356034, 0.30359612, 0.30362421, 0.30364626, 0.30366356, 0.30367714, 0.30368780, 0.30369617, 0.30370274, 0.30370789, 0.30371194, 0.30371511, 0.30371760, 0.30371956, 0.30372109, 0.30372230, 0.30372324, 0.30372399, 0.30372457)
  )
  ref_03 <- list(
    est = c(0.00000000, 0.02622504, 0.05050785, 0.07299228, 0.09381151, 0.11308886, 0.13093854, 0.14746627, 0.16276995, 0.17694024, 0.19006108, 0.20221019, 0.21345954, 0.22387576, 0.23352056, 0.24245106, 0.25072016, 0.25837686, 0.26546650, 0.27203109, 0.27810950, 0.28373774, 0.28894916, 0.29377461, 0.29824270, 0.30237987, 0.30621065, 0.30975772, 0.31304210, 0.31608323, 0.31889914, 0.32150650, 0.32392076, 0.32615622, 0.32822612, 0.33014272, 0.33191738, 0.33356061, 0.33508215, 0.33649099, 0.33779550, 0.33900340, 0.34012183, 0.34115744, 0.34211635, 0.34300425, 0.34382638, 0.34458763, 0.34529250, 0.34594517),
    lower = c(0.00000000, 0.02066558, 0.03990227, 0.05780384, 0.07445832, 0.08994832, 0.10435133, 0.11774003, 0.13018258, 0.14174283, 0.15248064, 0.16245205, 0.17170954, 0.18030222, 0.18827604, 0.19567396, 0.20253613, 0.20890007, 0.21480082, 0.22027109, 0.22534140, 0.23004021, 0.23439405, 0.23842765, 0.24216405, 0.24562468, 0.24882950, 0.25179710, 0.25454472, 0.25708842, 0.25944313, 0.26162270, 0.26363999, 0.26550697, 0.26723471, 0.26883352, 0.27031293, 0.27168179, 0.27294832, 0.27412011, 0.27520423, 0.27620720, 0.27713508, 0.27799346, 0.27878755, 0.27952214, 0.28020169, 0.28083032, 0.28141184, 0.28194978),
    upper = c(0.00000000, 0.03178450, 0.06111343, 0.08818072, 0.11316469, 0.13622941, 0.15752575, 0.17719250, 0.19535732, 0.21213765, 0.22764153, 0.24196834, 0.25520954, 0.26744930, 0.27876507, 0.28922816, 0.29890420, 0.30785366, 0.31613219, 0.32379108, 0.33087760, 0.33743527, 0.34350426, 0.34912158, 0.35432135, 0.35913507, 0.36359180, 0.36771835, 0.37153948, 0.37507804, 0.37835515, 0.38139030, 0.38420152, 0.38680547, 0.38921752, 0.39145193, 0.39352184, 0.39543944, 0.39721597, 0.39886187, 0.40038677, 0.40179959, 0.40310859, 0.40432142, 0.40544516, 0.40648635, 0.40745107, 0.40834494, 0.40917316, 0.40994056)
  )
  expect_equal(t01_ci, ref_01, tolerance = 1e-6)
  expect_equal(t12_ci, ref_12, tolerance = 1e-6)
  expect_equal(t23_ci, ref_23, tolerance = 1e-6)
  expect_equal(t13_ci, ref_13, tolerance = 1e-6)
  expect_equal(t03_ci, ref_03, tolerance = 1e-6)
})

## ----eval=F-------------------------------------------------------------------
test_that("write_loglikelihood works", {
  expect_message(
    write_loglikelihood(gg,abs_exact = TRUE),
    "The log-likelihood has been written to"
  )
})
